<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bricks Gym - Forge Your Strength</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-blue: #1e90ff;
            --primary-purple: #8b5cf6;
            --secondary-blue: #3b82f6;
            --light-bg: #f0f2f5;
            --light-bg-secondary: #e6e9ef;
            --dark-bg: #1a1a1a;
            --dark-bg-secondary: #2c2c2c;
            --text-light: #333333;
            --text-dark: #e0e0e0;
            --border-light: #d1d5db;
            --border-dark: #4b5563;
            --white: #ffffff;
            --error-color: #dc2626;
            --success-color: #16a34a;
            --header-height: 80px;
        }

        body.dark {
            --light-bg: var(--dark-bg);
            --light-bg-secondary: var(--dark-bg-secondary);
            --text-light: var(--text-dark);
            --border-light: var(--border-dark);
            --primary-blue: #60a5fa;
            --primary-purple: #a78bfa;
            --secondary-blue: #93c5fd;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        }

        body {
            background: linear-gradient(135deg, var(--primary-blue), var(--primary-purple));
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: var(--text-light);
            position: relative;
            overflow-x: hidden;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        header {
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-purple));
            color: var(--white);
            padding: 15px 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: var(--header-height);
        }

        body.dark header {
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-purple));
        }

        header h1 {
            font-family: 'Montserrat', sans-serif;
            font-size: clamp(1.8rem, 5vw, 2.2rem);
            font-weight: 600;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: var(--white);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .theme-toggle:focus {
            outline: 2px solid var(--white);
            outline-offset: 2px;
        }

        .motivational-quote {
            margin: calc(var(--header-height) + 20px) auto 20px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--white);
            padding: 12px 20px;
            border-radius: 12px;
            font-style: italic;
            font-size: clamp(0.9rem, 3vw, 1.1rem);
            text-align: center;
            max-width: 90%;
            opacity: 0;
            animation: fadeInQuote 1.5s ease-in-out forwards;
            transition: opacity 0.5s ease-in-out;
        }

        @keyframes fadeInQuote {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        main {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: calc(var(--header-height) + 20px) 15px 20px;
            min-height: calc(100vh - var(--header-height));
            position: relative;
            z-index: 10;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            padding: clamp(20px, 5vw, 30px);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 450px;
            backdrop-filter: blur(4px);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        body.dark .auth-container {
            background: rgba(42, 42, 42, 0.95);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }

        .tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            gap: 8px;
            border-bottom: 1px solid var(--border-light);
        }

        body.dark .tabs {
            border-bottom: 1px solid var(--border-dark);
        }

        .tab {
            background: var(--light-bg-secondary);
            color: var(--text-light);
            padding: 10px 20px;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 500;
            border: 1px solid var(--border-light);
            border-bottom: none;
            transition: background-color 0.3s ease, color 0.3s ease, transform 0.2s ease;
        }

        body.dark .tab {
            background: var(--dark-bg-secondary);
            border: 1px solid var(--border-dark);
        }

        .tab.active {
            background: linear-gradient(45deg, var(--primary-blue), var(--primary-purple));
            color: var(--white);
            border-color: var(--primary-blue);
            transform: translateY(-2px);
        }

        body.dark .tab.active {
            background: linear-gradient(45deg, var(--primary-blue), var(--primary-purple));
            border-color: var(--primary-purple);
        }

        .tab:hover:not(.active) {
            background: var(--light-bg);
            transform: translateY(-1px);
        }

        body.dark .tab:hover:not(.active) {
            background: var(--dark-bg);
        }

        .tab:focus {
            outline: 2px solid var(--primary-blue);
            outline-offset: 2px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        h2 {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 20px;
            font-size: clamp(1.5rem, 4vw, 1.8rem);
            font-weight: 600;
            font-family: 'Montserrat', sans-serif;
        }

        body.dark h2 {
            color: var(--text-dark);
        }

        form {
            display: flex;
            flex-direction: column;
        }

        .category-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-light);
            font-size: 0.9rem;
        }

        body.dark .category-label {
            color: var(--text-dark);
        }

        .input-group {
            margin-bottom: 15px;
            position: relative;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-light);
            border-radius: 8px;
            font-size: 1rem;
            background: var(--white);
            color: var(--text-light);
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        body.dark input, body.dark select {
            background: var(--dark-bg-secondary);
            border-color: var(--border-dark);
            color: var(--text-dark);
        }

        input:focus, select:focus {
            border-color: var(--primary-blue);
            box-shadow: 0 0 6px rgba(30, 144, 255, 0.3);
            outline: none;
        }

        body.dark input:focus, body.dark select:focus {
            border-color: var(--primary-purple);
            box-shadow: 0 0 6px rgba(139, 92, 246, 0.3);
        }

        input[readonly] {
            background: var(--light-bg-secondary);
            cursor: not-allowed;
        }

        body.dark input[readonly] {
            background: var(--dark-bg-secondary);
        }

        select {
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 18px;
        }

        body.dark select {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23e0e0e0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
        }

        .show-password {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: var(--text-light);
            font-size: 0.85rem;
            font-weight: 500;
        }

        body.dark .show-password {
            color: var(--text-dark);
        }

        button {
            background: linear-gradient(45deg, var(--primary-blue), var(--primary-purple));
            color: var(--white);
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            margin-top: 12px;
            text-transform: uppercase;
            transition: background 0.3s ease, box-shadow 0.3s ease, transform 0.2s ease;
        }

        body.dark button {
            background: linear-gradient(45deg, var(--primary-blue), var(--primary-purple));
        }

        button:disabled {
            background: var(--border-light);
            cursor: not-allowed;
            box-shadow: none;
        }

        body.dark button:disabled {
            background: var(--border-dark);
        }

        button:hover:not(:disabled) {
            background: linear-gradient(45deg, var(--primary-purple), var(--primary-blue));
            box-shadow: 0 4px 10px rgba(30, 144, 255, 0.3);
            transform: translateY(-1px);
        }

        .google-login, .anonymous-login {
            background: linear-gradient(45deg, #3b82f6, #1d4ed8);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding: 12px;
        }

        body.dark .google-login, body.dark .anonymous-login {
            background: linear-gradient(45deg, #1d4ed8, #3b82f6);
        }

        .anonymous-login {
            background: linear-gradient(45deg, #6b7280, #4b5563);
        }

        body.dark .anonymous-login {
            background: linear-gradient(45deg, #4b5563, #6b7280);
        }

        .google-login:hover:not(:disabled), .anonymous-login:hover:not(:disabled) {
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
            transform: translateY(-1px);
        }

        .google-login svg {
            width: 20px;
            height: 20px;
        }

        .error {
            color: var(--error-color);
            background: rgba(220, 38, 38, 0.1);
            text-align: center;
            margin: 12px 0;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px;
            border-radius: 6px;
            display: none;
        }

        .success {
            color: var(--success-color);
            background: rgba(22, 163, 74, 0.1);
            text-align: center;
            margin: 12px 0;
            font-size: 0.9rem;
            font-weight: 500;
            padding: 8px;
            border-radius: 6px;
            display: none;
        }

        .shake {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-4px); }
            20%, 40%, 60%, 80% { transform: translateX(4px); }
        }

        footer {
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-purple));
            color: var(--white);
            text-align: center;
            padding: 15px;
            font-size: 0.9rem;
            position: relative;
            z-index: 10;
        }

        body.dark footer {
            background: linear-gradient(90deg, var(--primary-blue), var(--primary-purple));
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-blue);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
            display: none;
        }

        body.dark .spinner {
            border-left-color: var(--primary-purple);
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            header h1 {
                font-size: clamp(1.6rem, 4vw, 2rem);
            }
            .motivational-quote {
                font-size: clamp(0.85rem, 2.5vw, 1rem);
                padding: 10px 15px;
            }
            .auth-container {
                max-width: 400px;
            }
        }

        @media (max-width: 768px) {
            :root {
                --header-height: 60px;
            }
            header {
                padding: 10px 20px;
            }
            main {
                padding: calc(var(--header-height) + 10px) 15px 20px;
            }
            .tabs {
                flex-direction: column;
                border-bottom: none;
            }
            .tab {
                border-radius: 8px;
                margin-bottom: 8px;
            }
            .auth-container {
                max-width: 90%;
                padding: 20px;
            }
        }

        @media (max-width: 480px) {
            header h1 {
                font-size: clamp(1.4rem, 3.5vw, 1.6rem);
            }
            h2 {
                font-size: clamp(1.3rem, 3vw, 1.5rem);
            }
            .auth-container {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Bricks Gym</h1>
        <button class="theme-toggle" id="theme-toggle" role="button" aria-label="Switch to dark theme">ðŸŒ™</button>
    </header>

    <div class="motivational-quote" role="status" aria-live="polite">
        "Strength does not come from what you can do. It comes from overcoming the things you once thought you could not do."
    </div>

    <main>
        <div class="auth-container">
            <div class="tabs" role="tablist">
                <div id="tab-login" class="tab active" role="tab" aria-selected="true" tabindex="0">Log In</div>
                <div id="tab-register" class="tab" role="tab" aria-selected="false" tabindex="0">Register</div>
                <div id="tab-forgot" class="tab" role="tab" aria-selected="false" tabindex="0">Forgot Password</div>
            </div>

            <div id="login-tab" class="tab-content active" role="tabpanel" aria-labelledby="tab-login">
                <h2>Login to Your Account</h2>
                <form id="login-form">
                    <div class="input-group">
                        <label for="login-email" class="category-label">Email</label>
                        <input type="email" id="login-email" placeholder="Enter your email" required autocomplete="username">
                    </div>
                    <div class="input-group">
                        <label for="login-password" class="category-label">Password</label>
                        <input type="password" id="login-password" placeholder="Password" required autocomplete="current-password">
                        <span class="show-password" id="login-password-toggle" role="button" tabindex="0" aria-label="Toggle password visibility">Show</span>
                    </div>
                    <div class="input-group">
                        <label for="login-gender" class="category-label">Category (select for dashboard access)</label>
                        <select id="login-gender" required>
                            <option value="">Select a category</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <button type="submit" aria-label="Submit login form">Secure Login</button>
                </form>
                <button class="google-login" id="google-login-btn" aria-label="Log in with Google">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="white">
                        <path d="M12.24 10.285V14.4h6.806c-.275 1.765-2.056 5.174-6.806 5.174-4.095 0-7.439-3.389-7.439-7.574s3.344-7.574 7.439-7.574c2.327 0 3.904.91 4.785 1.692l3.258-3.132C18.285 1.781 15.616 0 12.24 0 6.96 0 2.45 4.027 2.45 9s4.51 9 9.79 9c5.454 0 9.027-3.835 9.027-9.228 0-.619-.056-1.226-.162-1.818h-8.905z"/>
                    </svg>
                    Log in with Google
                </button>
                <button class="anonymous-login" id="anonymous-login-btn" aria-label="Try as guest login">Try as Guest</button>
                <p id="login-error" class="error" role="alert"></p>
                <p id="login-success" class="success" role="alert"></p>
            </div>

            <div id="register-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-register">
                <h2>Join Bricks Gym!</h2>
                <form id="register-form">
                    <div class="input-group">
                        <label for="register-name" class="category-label">Full Name</label>
                        <input type="text" id="register-name" placeholder="Full Name" required autocomplete="name">
                    </div>
                    <div class="input-group">
                        <label for="register-email" class="category-label">Email</label>
                        <input type="email" id="register-email" placeholder="Enter your email" required autocomplete="email">
                    </div>
                    <div class="input-group">
                        <label for="register-password" class="category-label">Password</label>
                        <input type="password" id="register-password" placeholder="Password" required autocomplete="new-password">
                        <span class="show-password" id="register-password-toggle" role="button" tabindex="0" aria-label="Toggle password visibility">Show</span>
                    </div>
                    <div class="input-group">
                        <label for="register-gender" class="category-label">Category (Select for personalized dashboard)</label>
                        <select id="register-gender" required>
                            <option value="">Select a category</option>
                            <option value="male">Male</option>
                            <option value="female">Female</option>
                        </select>
                    </div>
                    <button type="submit" aria-label="Submit registration form">Submit</button>
                </form>
                <p id="register-error" class="error" role="alert"></p>
                <p id="register-success" class="success" role="alert"></p>
            </div>

            <div id="forgot-tab" class="tab-content" role="tabpanel" aria-labelledby="tab-forgot">
                <h2>Reset Your Password</h2>
                <form id="forgot-password-form">
                    <div class="input-group">
                        <label for="forgot-email" class="category-label">Email</label>
                        <input type="email" id="forgot-email" placeholder="Enter your registered email" required autocomplete="email">
                    </div>
                    <button type="submit" aria-label="Submit password reset form">Reset</button>
                </form>
                <p id="forgot-error" class="error" role="alert"></p>
                <p id="forgot-success" class="success" role="alert"></p>
            </div>
        </div>
    </main>

    <footer>
        <p>Â© 2025 Bricks Gym. All rights reserved. | Built with Strength & Dedication. Developed by OmprakashSuthar under UM</p>
    </footer>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, signInAnonymously, sendPasswordResetEmail, onAuthStateChanged, updateProfile } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

        // Firebase configuration
        const firebaseConfig = {
            // IMPORTANT: Replace with your actual Firebase project's API key
            apiKey: "AIzaSyAdbh13wPl4aKV_y4PkrUX30hN1kSPnPxE", // THIS IS A PLACEHOLDER KEY
            authDomain: "bricksgymmanagementsystem.firebaseapp.com",
            projectId: "bricksgymmanagementsystem",
            storageBucket: "bricksgymmanagementsystem.firebasestorage.app",
            messagingSenderId: "184009603704",
            appId: "1:184009603704:web:cbc41402a7c3ef1e3c4b8d",
            measurementId: "G-SPS6F9XG9J"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // DOM elements
        const authContainer = document.querySelector('.auth-container');
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const themeToggle = document.getElementById('theme-toggle');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const forgotPasswordForm = document.getElementById('forgot-password-form');
        const googleLoginButton = document.getElementById('google-login-btn');
        const anonymousLoginButton = document.getElementById('anonymous-login-btn');
        const motivationalQuote = document.querySelector('.motivational-quote');
        let isRedirecting = false;
        let processingLogout = false; // Flag to manage logout state

        // Create spinner element
        const spinner = document.createElement('div');
        spinner.className = 'spinner';
        document.body.appendChild(spinner);

        // Cache user data
        const userCache = new Map();

        // Display messages
        function displayMessage(elementId, message, isSuccess = false) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.className = isSuccess ? 'success' : 'error';
                element.style.display = 'block';
                if (!isSuccess) {
                    authContainer.classList.add('shake');
                    setTimeout(() => authContainer.classList.remove('shake'), 500);
                }
            }
        }

        // Friendly error messages
        function getFriendlyErrorMessage(error) {
            const errorMap = {
                'auth/invalid-email': 'Please enter a valid email address.',
                'auth/user-not-found': 'No account found with this email.',
                'auth/wrong-password': 'Incorrect password. Please try again.',
                'auth/email-already-in-use': 'This email is already in use.',
                'auth/weak-password': 'Password must be at least 6 characters long.',
                'auth/too-many-requests': 'Too many attempts. Please try again later.',
                'auth/popup-closed-by-user': 'Google login was cancelled.',
                'auth/network-request-failed': 'Network error. Please check your connection.'
            };
            return errorMap[error.code] || `An error occurred: ${error.code} - ${error.message}`;
        }

        // Theme toggle
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.classList.toggle('dark', savedTheme === 'dark');
            themeToggle.textContent = savedTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            themeToggle.setAttribute('aria-label', savedTheme === 'dark' ? 'Switch to light theme' : 'Switch to dark theme');

            themeToggle.addEventListener('click', () => {
                const isDark = document.body.classList.toggle('dark');
                themeToggle.textContent = isDark ? 'â˜€ï¸' : 'ðŸŒ™';
                themeToggle.setAttribute('aria-label', isDark ? 'Switch to light theme' : 'Switch to dark theme');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
            });
        }

        // Tab switching
        function initializeTabs() {
            tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab));
                tab.addEventListener('keypress', e => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        switchTab(tab);
                    }
                });
            });
        }

        function switchTab(selectedTab) {
            tabs.forEach(tab => {
                tab.classList.remove('active');
                tab.setAttribute('aria-selected', 'false');
            });
            selectedTab.classList.add('active');
            selectedTab.setAttribute('aria-selected', 'true');

            tabContents.forEach(content => content.classList.remove('active'));
            const tabId = selectedTab.id.replace('tab-', '');
            document.getElementById(`${tabId}-tab`).classList.add('active');

            clearMessages();
        }

        // Clear messages
        function clearMessages() {
            document.querySelectorAll('.error, .success').forEach(element => {
                element.style.display = 'none';
                element.textContent = '';
            });
            authContainer.classList.remove('shake');
        }

        // Password toggle
        function setupPasswordToggle(toggleBtnId, passwordInputId) {
            const toggleBtn = document.getElementById(toggleBtnId);
            const passwordInput = document.getElementById(passwordInputId);
            if (toggleBtn && passwordInput) {
                toggleBtn.addEventListener('click', togglePassword);
                toggleBtn.addEventListener('keypress', e => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        togglePassword();
                    }
                });

                function togglePassword() {
                    const type = passwordInput.type === 'password' ? 'text' : 'password';
                    passwordInput.type = type;
                    toggleBtn.textContent = type === 'password' ? 'Show' : 'Hide';
                    toggleBtn.setAttribute('aria-label', `Toggle password visibility to ${type === 'password' ? 'hidden' : 'visible'}`);
                }
            }
        }

        // Input validation
        function setupInputValidation() {
            document.querySelectorAll('input[required], select').forEach(input => {
                input.addEventListener('input', () => validateInput(input));
                input.addEventListener('blur', () => validateInput(input));
            });

            const registerPasswordInput = document.getElementById('register-password');
            if (registerPasswordInput) {
                registerPasswordInput.addEventListener('input', () => {
                    const value = registerPasswordInput.value;
                    if (value.length < 6 && value.length > 0) {
                        displayMessage('register-error', 'Password must be at least 6 characters.');
                    } else {
                        clearMessages();
                    }
                });
            }
        }

        function validateInput(input) {
            if (!input.value && input.hasAttribute('required')) {
                input.style.borderColor = 'var(--error-color)';
            } else if (input.type === 'email') {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(input.value) && input.value) {
                    input.style.borderColor = 'var(--error-color)';
                } else {
                    input.style.borderColor = 'var(--border-light)';
                }
            } else {
                input.style.borderColor = 'var(--border-light)';
            }
        }

        // Button loading state
        function setButtonLoading(button, isLoading) {
            if (isLoading) {
                button.disabled = true;
                button.style.opacity = '0.7';
                spinner.style.display = 'block';
            } else {
                button.disabled = false;
                button.style.opacity = '1';
                spinner.style.display = 'none';
            }
        }

        // Redirect user
        async function redirectUser(user, initialGender = null) {
            if (isRedirecting) return;
            isRedirecting = true;
            spinner.style.display = 'block';

            try {
                let userGender = userCache.get(user.uid)?.gender;
                if (!userGender) {
                    const userDocRef = doc(db, 'users', user.uid);
                    const docSnap = await getDoc(userDocRef);
                    if (docSnap.exists()) {
                        userGender = docSnap.data().gender;
                        userCache.set(user.uid, { gender: userGender });
                    }
                }

                if (!userGender && initialGender) {
                    try {
                        await setDoc(doc(db, 'users', user.uid), {
                            name: user.displayName || 'Gym Member',
                            email: user.email,
                            gender: initialGender,
                            role: 'member',
                            membershipStatus: 'trial',
                            workoutPreferences: [],
                            createdAt: serverTimestamp()
                        }, { merge: true });
                        userGender = initialGender;
                        userCache.set(user.uid, { gender: userGender });
                    } catch (error) {
                        console.error('Firestore write error:', error);
                        displayMessage('login-error', 'Failed to save user data.');
                        return;
                    }
                }

                // If a valid gender is determined, set auth flag and redirect
                if (userGender === 'male' || userGender === 'female' || userGender === 'guest') {
                    localStorage.setItem('auth', 'true'); // Signal to dashboard pages that auth is successful
                    if (userGender === 'male') {
                        window.location.href = 'boysdashboard.html';
                    } else if (userGender === 'female') {
                        window.location.href = 'girlsdashboard.html';
                    } else if (userGender === 'guest') {
                        window.location.href = 'guestdashboard.html';
                    }
                } else {
                    localStorage.removeItem('auth'); // Clear auth flag if redirect cannot proceed
                    displayMessage('login-error', 'Could not determine user category for dashboard. Please ensure a category is selected or try logging in again.');
                }
            } catch (error) {
                console.error('Redirect error:', error);
                displayMessage('login-error', 'An error occurred during redirection.');
                localStorage.removeItem('auth'); // Clear auth flag on error
            } finally {
                isRedirecting = false;
                spinner.style.display = 'none';
            }
        }

        // Login form submission
        loginForm.addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const gender = document.getElementById('login-gender').value;
            const loginButton = loginForm.querySelector('button[type="submit"]');

            if (!gender) {
                displayMessage('login-error', 'Please select a category.');
                return;
            }

            setButtonLoading(loginButton, true);
            try {
                const { user } = await signInWithEmailAndPassword(auth, email, password);
                await redirectUser(user, gender);
                displayMessage('login-success', 'Login successful! Redirecting...', true);
            } catch (error) {
                displayMessage('login-error', getFriendlyErrorMessage(error));
            } finally {
                setButtonLoading(loginButton, false);
            }
        });

        // Register form submission
        registerForm.addEventListener('submit', async e => {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            const gender = document.getElementById('register-gender').value;
            const registerButton = registerForm.querySelector('button[type="submit"]');

            if (!gender) {
                displayMessage('register-error', 'Please select a category.');
                return;
            }

            setButtonLoading(registerButton, true);
            try {
                const { user } = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(user, { displayName: name });
                await redirectUser(user, gender);
                displayMessage('register-success', 'Registration successful! Redirecting...', true);
            } catch (error) {
                displayMessage('register-error', getFriendlyErrorMessage(error));
            } finally {
                setButtonLoading(registerButton, false);
            }
        });

        // Forgot password form submission
        forgotPasswordForm.addEventListener('submit', async e => {
            e.preventDefault();
            const email = document.getElementById('forgot-email').value;
            const resetButton = forgotPasswordForm.querySelector('button[type="submit"]');

            setButtonLoading(resetButton, true);
            try {
                await sendPasswordResetEmail(auth, email);
                displayMessage('forgot-success', 'Password reset email sent! Check your inbox.', true);
            } catch (error) {
                displayMessage('forgot-error', getFriendlyErrorMessage(error));
            } finally {
                setButtonLoading(resetButton, false);
            }
        });

        // Google login
        googleLoginButton.addEventListener('click', async () => {
            const selectedGender = document.getElementById('login-gender').value;
            setButtonLoading(googleLoginButton, true);
            try {
                const { user } = await signInWithPopup(auth, provider);
                await redirectUser(user, selectedGender || null); // Pass selected gender if available
                displayMessage('login-success', 'Google login successful! Redirecting...', true);
            } catch (error) {
                displayMessage('login-error', getFriendlyErrorMessage(error));
            } finally {
                setButtonLoading(googleLoginButton, false);
            }
        });

        // Anonymous login
        anonymousLoginButton.addEventListener('click', async () => {
            setButtonLoading(anonymousLoginButton, true);
            try {
                const { user } = await signInAnonymously(auth);
                await redirectUser(user, 'guest');
                displayMessage('login-success', 'Guest login successful! Redirecting...', true);
            } catch (error) {
                displayMessage('login-error', getFriendlyErrorMessage(error));
            } finally {
                setButtonLoading(anonymousLoginButton, false);
            }
        });

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initializeTheme();
            initializeTabs();
            setupInputValidation();
            setupPasswordToggle('login-password-toggle', 'login-password');
            setupPasswordToggle('register-password-toggle', 'register-password');

            // Rotate quotes
            const quotes = [
                "Strength does not come from what you can do. It comes from overcoming the things you once thought you could not do.",
                "The body achieves what the mind believes.",
                "Success starts with self-discipline.",
                "The only bad workout is the one that didn't happen.",
                "Your body can stand almost anything. It's your mind you have to convince."
            ];
            let quoteIndex = 0;
            motivationalQuote.textContent = `"${quotes[quoteIndex]}"`;

            setInterval(() => {
                quoteIndex = (quoteIndex + 1) % quotes.length;
                motivationalQuote.style.opacity = 0;
                setTimeout(() => {
                    motivationalQuote.textContent = `"${quotes[quoteIndex]}"`;
                    motivationalQuote.style.opacity = 1;
                }, 500);
            }, 8000);

            // Auth state listener
            onAuthStateChanged(auth, async user => {
                if (user && !processingLogout) {
                    // If user is authenticated and we are not in the middle of a logout process,
                    // attempt to redirect them.
                    if (!isRedirecting) { // Ensure redirectUser isn't already running
                        await redirectUser(user);
                    }
                } else if (!user) {
                    // User is signed out or not authenticated.
                    if (localStorage.getItem('auth')) {
                        localStorage.removeItem('auth');
                    }
                    if (!processingLogout) spinner.style.display = 'none';
                }
            });

            // Keyboard navigation
            tabs.forEach(tab => {
                tab.addEventListener('keydown', e => {
                    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                        e.preventDefault();
                        const nextTab = tab.nextElementSibling || tabs[0];
                        nextTab.focus();
                        switchTab(nextTab);
                    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                        e.preventDefault();
                        const prevTab = tab.previousElementSibling || tabs[tabs.length - 1];
                        prevTab.focus();
                        switchTab(prevTab);
                    }
                });
            });

            // Focus styles
            document.querySelectorAll('input, select, button, .tab').forEach(element => {
                element.addEventListener('focus', () => {
                    element.style.outline = `2px solid var(--primary-blue)`;
                    element.style.outlineOffset = '2px';
                });
                element.addEventListener('blur', () => {
                    element.style.outline = 'none';
                });
            });

            // Handle logout if ?logout=true is in URL
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('logout')) {
                processingLogout = true;
                setButtonLoading(document.createElement('button'), true); // Show spinner
                signOut(auth).then(() => {
                    displayMessage('login-success', 'You have been successfully logged out.', true);
                }).catch((error) => {
                    console.error("Logout error:", error);
                    displayMessage('login-error', 'Error logging out: ' + getFriendlyErrorMessage(error));
                }).finally(() => {
                    localStorage.removeItem('auth');
                    userCache.clear(); // Clear any cached user data
                    
                    // Reset login form elements if needed
                    document.getElementById('login-email').value = '';
                    document.getElementById('login-password').value = '';
                    document.getElementById('login-gender').value = '';

                    // Remove the query parameter from URL without reloading
                    const newUrl = window.location.pathname;
                    history.replaceState({}, document.title, newUrl);
                    
                    processingLogout = false;
                    setButtonLoading(document.createElement('button'), false); // Hide spinner
                    switchTab(document.getElementById('tab-login')); // Ensure login tab is active
                });
            }
        });
    </script>
</body>
</html>